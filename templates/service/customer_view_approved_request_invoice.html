{% extends 'service/customerbase.html' %}
{% load static %}
{% block content %}
    <!-- main content -->
    <div class="wrapper">
        <!-- ****** table start ********** -->
        <div class="row">
            <div class="col-12 col-m-12 col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <h3 style="color:red; text-align:center">Requests and Offers</h3>
                    </div>
                    <div class="card-content">
                        <table id="requests-offers-table">
                            <thead>
                                <tr>
                                    <th>Agreement Name</th>
                                    <th>Project Information</th>
                                    <th>Employee Name</th>
                                    <th>Provider Name</th>
                                    <th>Contact Person</th>
                                    <th>External Person</th>
                                    <th>Budget</th>
                                    <th>Status</th>
                                    <th>Accept</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enq in offers %}
                                    <tr>
                                        <td>{{enq.agreement_title}}</td>
                                        <td>{{enq.project_information}}</td>
                                        <td>{{enq.employee_name}}</td>
                                        <td>{{enq.provider_name}}</td>
                                        <td>{{enq.contactperson}}</td>
                                        <td>{{enq.externalperson}}</td>
                                        <td>{{enq.rate}}</td>
                                        <td class="status-cell">{{enq.status}}</td> <!-- Add a class to the status cell -->
                                        <!-- Accept button with form -->
                                        <td>
                                            <form class="accept-form" method="post" action="/customer-view-approved-offers/{{ enq.rate }}/">
                                                {% csrf_token %}
                                                <input type="hidden" name="rate" value="{{ enq.rate }}">
                                                <button type="submit" class="accept-btn" style="color:green; text-decoration:none; font-size:25px;" onclick="return approveOffer(this);">&#10003;</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- ****** table end ********** -->
        <!-- end approved offers section -->

        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
    </div>
    <!-- end main content -->
</div>
<!-- end main content -->

<script>
    function approveOffer(button) {
        const form = button.closest('form');
        const formData = new FormData(form);
        const rate = formData.get('rate');
        const statusCell = button.closest('tr').querySelector('.status-cell');

        fetch(`/customer-view-approved-offers/${rate}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
        })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                // Update the status in the current row from "Available" to "Approved"
                statusCell.textContent = 'Approved';
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });

        return false; // Prevent the form from submitting
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + '=') {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>


{% endblock content %}
